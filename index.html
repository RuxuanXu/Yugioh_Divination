<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>遊☆戲☆王☆占☆卜</title>
	<link id="style" rel="stylesheet" href="style.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    </script>
  </head>
  <body>=
	<video autoplay muted loop id="background">
	  <source src="background.mp4" type="video/mp4">
	</video>
    <center class="foreground">
      <H1>遊☆戲☆王☆占☆卜</H1>
	  <div class="scroll">
		  <input type="image" class="card" id="card01" src="cover.jpg"/>
		  <input type="image" class="card" id="card02" src="cover.jpg"/>
		  <input type="image" class="card" id="card03" src="cover.jpg"/>
		  <input type="image" class="card" id="card04" src="cover.jpg"/>
		  <input type="image" class="card" id="card05" src="cover.jpg"/>
	  </div>
	  <br><br>
	  <button id="status" onclick="">卡片資料載入中...</button>
    </center>
  </body>
  
<script>
var card_dict = "";
var card_class = document.getElementsByClassName("card");

var flip = function(e){
	if(!card_dict)return;
	var rand_card = getRandCard();
	e.target.src = rand_card[0];
	e.target.removeEventListener('click', flip, false);
	//e.target.removeEventListener('touchstart', flip, false);
	var link_url = rand_card[1];
	$("#"+e.srcElement.id).wrap($("<a class='wrapper' target='_blank'>").attr("href", link_url));
}

function unwrap(wrapper) {
	for (var i = 0; i < wrapper.length; i++){
		var docFrag = document.createDocumentFragment();
		while (wrapper[i].firstChild)
			docFrag.appendChild(wrapper[i].firstChild);
		wrapper[i].parentNode.replaceChild(docFrag, wrapper[i]);
	}
}

function shuffle(){
    //window.location.reload(); 
	for (var i = 0; i < card_class.length; i++){
		card_class[i].addEventListener('click', flip, false);
		//card_class[i].addEventListener('touchstart', flip, false);
		card_class[i].src = "cover.jpg";
    }
	unwrap(document.getElementsByClassName("wrapper"));
}

function getRandCard(){
	var card_num = 5;
	var rand_num = Math.floor(Math.random() * card_dict.length);
	if(!card_dict[rand_num].card_images) 
		return getRandCard();
	var rand_img = Math.floor(Math.random() * card_dict[rand_num].card_images.length);
	var src = card_dict[rand_num].card_images[rand_img].image_url; 
	var url = "https://asia.xpg.cards/card?id=" + card_dict[rand_num].id;
	return [src, url];
}

function getCards(url){
    var request = new XMLHttpRequest();
    request.open('GET', 'https://db.ygoprodeck.com/api/v5/cardinfo.php', true)
    request.onload = function() {
		card_dict = JSON.parse(this.response);
		document.getElementById("status").innerHTML = "重新抽牌";
		document.getElementById("status").onclick = shuffle;
	}
	request.send()
}

getCards();

for (var i = 0; i < card_class.length; i++){
    card_class[i].addEventListener('click', flip, false);
    //card_class[i].addEventListener('touchstart', flip, false);
}

</script>

</html>
